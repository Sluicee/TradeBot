#!/bin/bash

# Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ· Ğ±ÑĞºĞ°Ğ¿Ğ°

set -e

echo "ğŸ”„ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Trading Bot..."
echo ""

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ Ğ±ÑĞºĞ°Ğ¿Ğ¾Ğ²
if [ ! -d "backups" ]; then
	echo "âŒ Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ backups Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°!"
	exit 1
fi

# Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… Ğ±ÑĞºĞ°Ğ¿Ğ¾Ğ²
echo "Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ Ğ±ÑĞºĞ°Ğ¿Ñ‹:"
echo ""

BACKUPS=($(ls -t backups/backup_* 2>/dev/null))

if [ ${#BACKUPS[@]} -eq 0 ]; then
	echo "âŒ Ğ‘ÑĞºĞ°Ğ¿Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹!"
	exit 1
fi

# ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº
for i in "${!BACKUPS[@]}"; do
	SIZE=$(du -sh "${BACKUPS[$i]}" 2>/dev/null | cut -f1)
	DATE=$(basename "${BACKUPS[$i]}" | sed 's/backup_//' | sed 's/_/ /')
	echo "  [$i] $DATE ($SIZE)"
done

echo ""
read -p "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ±ÑĞºĞ°Ğ¿Ğ° Ğ´Ğ»Ñ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ: " CHOICE

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ°
if ! [[ "$CHOICE" =~ ^[0-9]+$ ]] || [ "$CHOICE" -ge "${#BACKUPS[@]}" ]; then
	echo "âŒ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€!"
	exit 1
fi

BACKUP_DIR="${BACKUPS[$CHOICE]}"
echo ""
echo "Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¸Ğ·: $BACKUP_DIR"
echo ""

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‡Ñ‚Ğ¾ Ğ±Ğ¾Ñ‚ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½
if docker ps | grep -q tradebot; then
	echo "âš ï¸  Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½!"
	read -p "ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ°? (y/N) " -n 1 -r
	echo
	if [[ $REPLY =~ ^[Yy]$ ]]; then
		if docker compose version &> /dev/null; then
			docker compose down
		else
			docker-compose down
		fi
	else
		echo "âŒ ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ Ğ±Ğ¾Ñ‚Ğ° Ğ¿ĞµÑ€ĞµĞ´ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸ĞµĞ¼!"
		exit 1
	fi
fi

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ±ÑĞºĞ°Ğ¿Ğ° Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
echo "ğŸ’¾ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ±ÑĞºĞ°Ğ¿Ğ° Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²..."
CURRENT_BACKUP="backups/before_restore_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$CURRENT_BACKUP"
[ -f ".env" ] && cp .env "$CURRENT_BACKUP/"
[ -f "paper_trading_state.json" ] && cp paper_trading_state.json "$CURRENT_BACKUP/"
[ -f "tracked_symbols.json" ] && cp tracked_symbols.json "$CURRENT_BACKUP/"
echo "âœ… Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾ Ğ²: $CURRENT_BACKUP"
echo ""

# Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
COUNT=0

if [ -f "$BACKUP_DIR/.env" ]; then
	cp "$BACKUP_DIR/.env" .
	echo "âœ“ .env Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"
	((COUNT++))
fi

if [ -f "$BACKUP_DIR/paper_trading_state.json" ]; then
	cp "$BACKUP_DIR/paper_trading_state.json" .
	echo "âœ“ paper_trading_state.json Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"
	((COUNT++))
fi

if [ -f "$BACKUP_DIR/tracked_symbols.json" ]; then
	cp "$BACKUP_DIR/tracked_symbols.json" .
	echo "âœ“ tracked_symbols.json Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"
	((COUNT++))
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾!"
echo "Ğ¤Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾: $COUNT"
echo ""
echo "Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ Ğ±Ğ¾Ñ‚Ğ°:"
if docker compose version &> /dev/null; then
	echo "  docker compose up -d"
else
	echo "  docker-compose up -d"
fi
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"


# Dashboard Updates: Bot Status & Log Viewer

**Дата**: 2025-10-12

## Новые возможности

### 1. 🤖 Индикатор состояния бота в Sidebar

**Расположение**: Верхняя часть sidebar (над навигацией)

**Отображает**:
- ✅/❌ Статус работы (на основе времени обновления state файла)
- 📝 Последнее обновление (сколько секунд/минут/часов назад)
- ⏱️ Uptime процесса (если psutil установлен)
- 📄 Наличие state файла
- 📋 Наличие лог-файла

**Логика определения статуса**:
```python
# Бот считается работающим если:
- state файл существует И
- обновлялся в последние 5 минут (300 секунд)
```

**Внешний вид**:
```
🤖 Состояние бота
✅ Работает
📝 Обновлено: 45 сек назад
⏱️ Uptime: 2ч 15м
📄 State ✓  📋 Logs ✓
```

---

### 2. 📋 Страница просмотра логов

**Доступ**: Навигация → "📋 Логи"

#### Возможности:

**Настройки отображения**:
- Количество строк: 20, 50, 100, 200, 500 (слайдер)
- Фильтр по уровню: ERROR, WARNING, INFO, DEBUG, CRITICAL
- Кнопка обновления

**Статистика логов** (4 метрики):
- Всего строк
- Ошибки (с отрицательной delta)
- Предупреждения (с отрицательной delta)
- Инфо

**Два режима отображения**:

1. **📜 Консоль** (вкладка 1):
   - Цветовая кодировка:
     - 🔴 ERROR/CRITICAL - красный
     - 🟡 WARNING - жёлтый
     - ⚪ DEBUG - серый code block
     - 🔵 INFO - обычный текст
   - Новые события сверху

2. **📊 Таблица** (вкладка 2):
   - DataFrame с колонками: level, message
   - Стилизованные строки (цвет по уровню)
   - Прокрутка, поиск, сортировка

**Дополнительно**:
- ℹ️ Справка по уровням логирования
- Полезные паттерны для поиска
- ⚠️ Опасная зона: очистка лог-файла

---

## Технические детали

### Новые функции

#### `check_bot_status() -> Dict`
Проверяет состояние торгового бота:
```python
{
    "is_running": bool,           # Работает ли бот
    "last_update": datetime,      # Время последнего обновления state
    "state_file_age": float,      # Возраст state файла (секунды)
    "log_file_exists": bool,      # Существует ли лог-файл
    "process_found": bool,        # Найден ли процесс (через psutil)
    "uptime": timedelta           # Время работы процесса
}
```

**Проверки**:
1. Существование и возраст `paper_trading_state.json`
2. Поиск процесса `main.py` через `psutil` (опционально)

#### `read_recent_logs(num_lines: int) -> List[str]`
Читает последние N строк из `trading_bot.log`:
- Использует простое чтение файла
- Возвращает последние `num_lines` строк
- Обработка ошибок (файл не найден, недоступен)

#### `parse_log_line(line: str) -> Dict`
Парсит строку лога:
```python
{
    "level": "ERROR" | "WARNING" | "INFO" | "DEBUG" | "CRITICAL",
    "message": "полный текст строки"
}
```

Определение уровня:
- Ищет ключевые слова в строке (ERROR, WARNING, etc.)
- По умолчанию: INFO

#### `render_bot_status_widget()`
Отрисовывает виджет состояния в sidebar:
- Вызывает `check_bot_status()`
- Форматирует возраст файла (сек/мин/часы)
- Отображает uptime (часы:минуты)
- 2 колонки для индикаторов файлов

#### `logs_page()`
Главная функция страницы логов:
- UI контролы (слайдер, мультиселект, кнопки)
- Чтение и парсинг логов
- Статистика (count по уровням)
- Два режима отображения (консоль/таблица)
- Справка и опасная зона

---

## Зависимости

**Добавлено в `requirements.txt`**:
```txt
psutil>=5.9.0  # Опционально - для определения uptime
```

**Импорт сделан graceful**:
```python
try:
    import psutil
except ImportError:
    psutil = None

# Использование:
if psutil:
    # код с psutil
```

Если `psutil` не установлен:
- Dashboard работает нормально
- Uptime не отображается
- Process detection не работает
- Остальной функционал доступен

---

## Конфигурация

**Константы в `dashboard.py`**:
```python
STATE_FILE = "paper_trading_state.json"  # Файл состояния
LOG_FILE = "trading_bot.log"            # Лог-файл
PROCESS_NAME = "main.py"                # Имя процесса для поиска
```

**Настройки проверки**:
```python
# check_bot_status()
MAX_STATE_AGE = 300  # секунд (5 минут) - бот считается живым
```

**Настройки логов**:
```python
# logs_page()
DEFAULT_NUM_LINES = 100              # Строк по умолчанию
DEFAULT_FILTERS = ["ERROR", "WARNING", "INFO"]  # Фильтры
```

---

## Использование

### Запуск Dashboard

```bash
# Установить зависимости
pip install streamlit plotly scipy psutil

# Запустить dashboard
streamlit run dashboard.py
```

**Опционально**: Без psutil (базовая функциональность):
```bash
pip install streamlit plotly scipy
streamlit run dashboard.py
```

### Просмотр состояния бота

1. Открыть dashboard
2. В sidebar сверху - индикатор состояния:
   - ✅ Зелёный = бот работает
   - ❌ Красный = бот не работает или давно не обновлялся

### Просмотр логов

1. Навигация → "📋 Логи"
2. Настроить фильтры (количество строк, уровни)
3. Выбрать вкладку "Консоль" или "Таблица"
4. Использовать кнопку "🔄 Обновить" для real-time мониторинга

### Поиск в логах

**Консольный режим**:
- Прокрутка вниз = старые события
- Прокрутка вверх = новые события

**Табличный режим**:
- Ctrl+F для поиска в браузере
- Клик на заголовок колонки для сортировки

**Полезные паттерны**:
- Найти ошибки API: фильтр "ERROR" + поиск "API"
- Найти сделки: поиск "BUY" или "SELL"
- Найти averaging: поиск "AVERAGING"
- Найти Kelly: поиск "Kelly"

---

## Возможные улучшения

**Будущие фичи**:

1. **Расширенный парсинг логов**:
   - Извлечение timestamp из строк
   - Определение компонента (API, Trading, Analysis)
   - Парсинг структурированных данных

2. **Фильтры по времени**:
   - Показать логи за последний час
   - Показать логи за день
   - Date range picker

3. **Поиск в логах**:
   - Regex поиск
   - Подсветка найденных совпадений
   - История поисков

4. **Алерты**:
   - Уведомление о новых ERROR
   - Webhook при критических ошибках
   - Telegram уведомления

5. **Экспорт логов**:
   - Скачать filtered logs как .txt
   - Экспорт в CSV
   - Архивирование старых логов

6. **Live streaming**:
   - WebSocket для real-time логов
   - Tail -f режим
   - Автообновление каждые N секунд

7. **Статистика**:
   - График ошибок по времени
   - Топ-10 частых ошибок
   - Heatmap активности

---

## Troubleshooting

### Проблема: "Лог-файл не найден"

**Причина**: Бот ещё не создал `trading_bot.log`

**Решение**:
1. Запустить бота хотя бы раз
2. Или создать пустой файл:
   ```bash
   echo "" > trading_bot.log
   ```

### Проблема: "psutil not found"

**Решение**:
```bash
pip install psutil
```

Или игнорировать - uptime просто не будет отображаться.

### Проблема: Индикатор показывает "❌ Не работает" хотя бот запущен

**Возможные причины**:
1. State файл не обновляется (проверить логи бота)
2. State файл старше 5 минут (настроить MAX_STATE_AGE)
3. Проблемы с записью state файла

**Решение**:
1. Проверить время модификации:
   ```bash
   ls -l paper_trading_state.json
   ```
2. Проверить содержимое state файла
3. Перезапустить бота

### Проблема: Слишком много логов, dashboard тормозит

**Решение**:
1. Уменьшить количество строк (20-50)
2. Использовать фильтры (только ERROR/WARNING)
3. Очистить старые логи
4. Настроить ротацию логов в боте

---

## Скриншоты (концепт)

### Индикатор в Sidebar

```
┌─────────────────────────┐
│ 📈 TradeBot             │
├─────────────────────────┤
│ 🤖 Состояние бота       │
│ ✅ Работает             │
│ 📝 Обновлено: 1 мин на  │
│ ⏱️ Uptime: 5ч 30м       │
│ 📄 State ✓  📋 Logs ✓   │
├─────────────────────────┤
│ Навигация               │
│ ○ 📊 Обзор              │
│ ○ 💼 Текущие позиции    │
│ ○ 📜 История сделок     │
│ ○ 📈 Метрики            │
│ ○ 🧪 Бэктесты           │
│ ● 📋 Логи               │ ← Активно
│ ○ ⚙️ Настройки          │
├─────────────────────────┤
│ ☐ Автообновление (60с)  │
│ [🔄 Обновить сейчас]    │
└─────────────────────────┘
```

### Страница Логов

```
┌──────────────────────────────────────────────────┐
│ 📋 Логи системы                                  │
├──────────────────────────────────────────────────┤
│ Количество строк: ◀──●──────▶ 100               │
│ Фильтр: [✓ERROR] [✓WARNING] [✓INFO] [ ]DEBUG   │
│                                    [🔄 Обновить] │
├──────────────────────────────────────────────────┤
│ Всего строк  │ Ошибки      │ Предупреждения │...│
│    150       │   5 (↓-5)   │   12 (↓-12)    │...│
├──────────────────────────────────────────────────┤
│ 📜 Консоль  │ 📊 Таблица                         │
├──────────────────────────────────────────────────┤
│ [ERROR] Failed to fetch candles: Timeout         │
│ [WARNING] Price dropped -5.2%, averaging trigger │
│ [INFO] AVERAGING: bought 0.00025 BTC @ $118500  │
│ [INFO] Position closed with profit: +$3.50      │
│ ...                                              │
└──────────────────────────────────────────────────┘
```

---

## Заключение

**Добавлено**:
✅ Индикатор состояния бота в sidebar  
✅ Страница просмотра логов с фильтрами  
✅ Статистика логов  
✅ Два режима отображения (консоль/таблица)  
✅ Цветовая кодировка по уровням  
✅ Graceful handling psutil (опционально)  

**Готово к использованию!** 🎯


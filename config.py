import os
import dotenv
import sys

dotenv.load_dotenv()

# ====================================================================
# TELEGRAM BOT
# ====================================================================
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
OWNER_CHAT_ID = os.getenv("OWNER_CHAT_ID")  # ID владельца бота

# Настройки по умолчанию (захардкожены в конфиге)
DEFAULT_SYMBOL = "BNBUSDT"  # Лучший результат в тестах: +11.5% за 41.7 дней
DEFAULT_INTERVAL = "1h"  # 1h для Hybrid Strategy (оптимально)

# ====================================================================
# ЛОГИРОВАНИЕ
# ====================================================================
# Компактный режим логирования (уменьшает размер логов)
COMPACT_LOGGING = True  # True = компактные логи, False = подробные логи
LOG_LEVEL = "INFO"  # DEBUG, INFO, WARNING, ERROR
SIGNAL_DIAG_COMPACT = True  # Компактный режим для диагностики сигналов

# Продакшен режим (максимально компактные логи)
PRODUCTION_LOGGING = False  # True = продакшен режим (только критичные события)
PRODUCTION_LOG_LEVEL = "WARNING"  # Уровень для продакшена

# Настройки фонового мониторинга
POLL_INTERVAL = 60  # Базовый интервал проверки сигналов (секунды)
POLL_INTERVAL_MIN = 60  # Минимальный интервал при низкой волатильности
POLL_INTERVAL_MAX = 300  # Максимальный интервал при высокой волатильности (5 минут)
VOLATILITY_WINDOW = 10  # Окно для детекции волатильности (свечей)
VOLATILITY_THRESHOLD = 0.05  # Порог волатильности для алерта (5%)
POLL_VOLATILITY_HIGH_THRESHOLD = 0.08  # Порог высокой волатильности (8%) - увеличиваем интервал
POLL_VOLATILITY_LOW_THRESHOLD = 0.02  # Порог низкой волатильности (2%) - можно проверять чаще
VOLATILITY_ALERT_COOLDOWN = 600  # Cooldown для повторных уведомлений о волатильности (10 минут)

# ====================================================================
# ИНДИКАТОРЫ (SignalGenerator)
# ====================================================================

# Параметры скользящих средних
SMA_PERIODS = [20, 50, 200]  # Периоды для SMA
EMA_PERIODS = [20, 50, 200]  # Периоды для EMA

# Основные EMA для пересечений
EMA_SHORT_WINDOW = 12
EMA_LONG_WINDOW = 26

# RSI
RSI_WINDOW = 14
RSI_OVERSOLD = 30  # Порог перепроданности
RSI_OVERSOLD_NEAR = 40  # Близко к перепроданности
RSI_OVERBOUGHT = 70  # Порог перекупленности
RSI_OVERBOUGHT_NEAR = 60  # Близко к перекупленности
RSI_BUY_RANGE = (30, 60)  # Диапазон для входа в BUY (перепроданность)
RSI_SELL_RANGE = (60, 100)  # Диапазон для входа в SELL (перекупленность)

# MACD
MACD_FAST = 12
MACD_SLOW = 26
MACD_SIGNAL = 9

# ADX (сила тренда)
ADX_WINDOW = 14
ADX_TRENDING = 25
ADX_RANGING = 15
ADX_STRONG = 25  # Порог для фильтра сильного тренда (ADX >= 25)
ADX_MODERATE = 20  # Минимальный порог тренда (ADX >= 20) - отличается от RANGING по направлению

# Stochastic
STOCH_WINDOW = 14
STOCH_SMOOTH_WINDOW = 3
STOCH_OVERSOLD = 20
STOCH_OVERBOUGHT = 80

# ATR (волатильность)
ATR_WINDOW = 14

# Volume
VOLUME_MA_WINDOW = 20
VOLUME_HIGH_RATIO = 1.5  # Высокий объем (150% от среднего)
VOLUME_MODERATE_RATIO = 1.2  # Умеренно высокий объем (120%)
VOLUME_LOW_RATIO = 0.7  # Низкий объем (70%)

# ====================================================================
# ВЕСА И ПОРОГИ ГОЛОСОВАНИЯ
# ====================================================================

# Веса индикаторов в зависимости от режима рынка
TRENDING_TREND_WEIGHT = 2  # Вес трендовых индикаторов в тренде
TRENDING_OSCILLATOR_WEIGHT = 2  # Вес осцилляторов в тренде

RANGING_TREND_WEIGHT = 1  # Вес трендовых индикаторов во флэте
RANGING_OSCILLATOR_WEIGHT = 2  # Вес осцилляторов во флэте

TRANSITIONING_TREND_WEIGHT = 2  # Вес трендовых индикаторов при переходе
TRANSITIONING_OSCILLATOR_WEIGHT = 2  # Вес осцилляторов при переходе

# Пороги голосования для генерации сигнала (ОПТИМИЗИРОВАНО на основе реальных данных: Win Rate 23% → ужесточаем фильтры)
VOTE_THRESHOLD_TRENDING = 3      # Увеличено с 2 до 3 (повышение качества сигналов)
VOTE_THRESHOLD_RANGING = 5       # Увеличено с 4 до 5 (повышение качества сигналов)
VOTE_THRESHOLD_TRANSITIONING = 6 # Увеличено с 5 до 6 (повышение качества сигналов)

# Минимальное количество пройденных фильтров для сигнала (УЖЕСТОЧЕНО)
MIN_FILTERS = 3  # Увеличено с 2 до 3 (из 5 возможных фильтров) - повышение качества
MIN_FILTERS_SELL = 2  # Увеличено с 1 до 2 для SELL сигналов (более строгие условия)

# ====================================================================
# PAPER TRADING & BACKTEST
# ====================================================================

# Комиссия биржи
COMMISSION_RATE = 0.0018  # 0.18%

# Управление позициями
MAX_POSITIONS = 3  # Базовое максимальное количество одновременных позиций (используется как fallback)
INITIAL_BALANCE = 100.0  # Начальный баланс для paper trading

# BTC-корреляция (ВНИМАНИЕ: может блокировать 90% сделок в крипторынке)
#ENABLE_BTC_CORRELATION_CHECK = True  # Проверять корреляцию с BTC
#MAX_BTC_CORRELATED_POSITIONS = 1  # Максимум 1 позиция из высоко коррелированных с BTC

# АЛЬТЕРНАТИВНЫЕ НАСТРОЙКИ ДЛЯ БОЛЕЕ ГИБКОЙ ТОРГОВЛИ:
ENABLE_BTC_CORRELATION_CHECK = False  # Отключить BTC-корреляцию полностью
MAX_BTC_CORRELATED_POSITIONS = 3     # Разрешить больше BTC-коррелированных позиций

# Динамическое изменение MAX_POSITIONS на основе баланса
USE_DYNAMIC_MAX_POSITIONS = True  # Включить динамический расчет максимального количества позиций
DYNAMIC_POSITIONS_THRESHOLDS = {
	# баланс: макс_позиций
	0: 3,        # <$100: 3 позиции (консервативно)
	100: 4,      # $100-$500: 4 позиции (базовый режим)
	500: 5,      # $500-$1000: 5 позиции
	1000: 6,     # $1000-$2000: 6 позиций
	2000: 7,     # $2000+: 7 позиций (максимум)
}
MAX_DYNAMIC_POSITIONS_LIMIT = 7  # Абсолютный максимум позиций независимо от баланса

# ====================================================================
# KELLY CRITERION
# ====================================================================

# Использовать Kelly Criterion для оптимального размера позиции (ИСПРАВЛЕНО)
USE_KELLY_CRITERION = True
KELLY_FRACTION = 0.15  # ИСПРАВЛЕНО: 15% Kelly для консервативности (было 20%)
MIN_TRADES_FOR_KELLY = 15  # Минимум сделок для расчёта Kelly
KELLY_LOOKBACK_WINDOW = 50  # Скользящее окно последних N сделок
KELLY_NEGATIVE_MULTIPLIER = 0.3  # Множитель при отрицательном Kelly (30% от базового)

# ====================================================================
# УМНОЕ ДОКУПАНИЕ (AVERAGING)
# ====================================================================

# Включить умное докупание/пирамидинг
ENABLE_AVERAGING = True
MAX_AVERAGING_ATTEMPTS = 2  # Максимум 2-3 докупания на позицию
AVERAGING_PRICE_DROP_PERCENT = 0.05  # Докупаем при падении на 5%
AVERAGING_TIME_THRESHOLD_HOURS = 24  # Время для триггера докупания (24 часа)
MAX_TOTAL_RISK_MULTIPLIER = 1.5  # Общий риск не более 1.5× базового

# Защита от переинвестирования при больших убытках
MAX_POSITION_DRAWDOWN_PERCENT = 0.15  # Максимальный drawdown позиции для докупания (15%)
MAX_AVERAGING_DRAWDOWN_PERCENT = 0.25  # Максимальный drawdown для докупания (25%)

# Пирамидинг вверх при сильном тренде
ENABLE_PYRAMID_UP = True
PYRAMID_ADX_THRESHOLD = 25  # Порог ADX для пирамидинга вверх
AVERAGING_SIZE_PERCENT = 0.5  # Размер докупания (50% от исходного)

# Стоп-лосс и тейк-профит (ОПТИМИЗИРОВАНО: улучшение R:R с 0.89:1 до 1.5:1)
STOP_LOSS_PERCENT = 0.04  # 4% стоп-лосс (уменьшено с 5% для лучшего R:R)
TAKE_PROFIT_PERCENT = 0.06  # 6% тейк-профит (уменьшено с 7% для более быстрого достижения, R:R = 1.5:1)
PARTIAL_CLOSE_PERCENT = 0.50  # Закрываем 50% позиции на TP
TRAILING_STOP_PERCENT = 0.015  # 1.5% trailing stop (уменьшено с 2% для более агрессивной защиты прибыли)

# Динамический стоп-лосс на основе ATR (ОПТИМИЗИРОВАНО: улучшение R:R)
DYNAMIC_SL_ATR_MULTIPLIER = 3.5  # 3.5x ATR (уменьшено с 4.0 для более тесного SL)
DYNAMIC_SL_MIN = 0.035  # Минимум 3.5% (уменьшено с 5% для лучшего R:R)
DYNAMIC_SL_MAX = 0.12  # Максимум 12% (уменьшено с 15% для более консервативного подхода)

# Размеры позиций по силе сигнала (ОПТИМИЗИРОВАНО: снижение риска при низком Win Rate 23%)
POSITION_SIZE_STRONG = 0.60  # 60% для сильного сигнала (уменьшено с 70% для снижения риска)
POSITION_SIZE_MEDIUM = 0.40  # 40% для среднего сигнала (уменьшено с 50% для снижения риска)
POSITION_SIZE_WEAK = 0.25  # 25% для слабого сигнала (уменьшено с 30% для снижения риска)

# Break-even Stop Loss (защита прибыли) (ОПТИМИЗИРОВАНО: более агрессивная защита)
BREAKEVEN_PROFIT_THRESHOLD = 0.015  # При +1.5% прибыли (уменьшено с 2% для более ранней защиты)
BREAKEVEN_ENABLED = True
SIGNAL_STRENGTH_STRONG = 9  # Порог для сильного сигнала
SIGNAL_STRENGTH_MEDIUM = 6  # Порог для среднего сигнала

# Корректировка размера позиции на волатильность
VOLATILITY_HIGH_THRESHOLD = 3.0  # ATR > 3% - высокая волатильность
VOLATILITY_LOW_THRESHOLD = 1.0  # ATR < 1% - низкая волатильность
VOLATILITY_ADJUSTMENT_MAX = 1.2  # Максимальное увеличение размера

# Время удержания позиции (ОПТИМИЗИРОВАНО: уменьшено для более быстрого оборота)
MAX_HOLDING_HOURS = 48  # Максимум 48 часов (2 дня) для Trend Following (уменьшено с 72h)
# MR_MAX_HOLDING_HOURS задан ниже в секции Mean Reversion (строка 231)

# Partial Take Profit (ОПТИМИЗИРОВАНО: более агрессивное фиксирование прибыли)
USE_PARTIAL_TP = True  # Включить частичное закрытие позиции
PARTIAL_TP_PERCENT = 0.5  # Закрывать 50% позиции
PARTIAL_TP_TRIGGER = 0.008  # На +0.8% прибыли (уменьшено с 1% для более раннего фиксирования)
PARTIAL_TP_REMAINING_TP = 0.015  # TP для оставшихся 50%: +1.5% (уменьшено с 2% для более быстрого выхода)

# ====================================================================
# СТАТИСТИЧЕСКИЕ МОДЕЛИ
# ====================================================================

# Включить статистические модели (Bayesian, Z-score, Markov)
USE_STATISTICAL_MODELS = True  # По умолчанию выключено (требует обучения)

# Bayesian Decision Layer (ОПТИМИЗИРОВАНО: повышение порога вероятности)
BAYESIAN_MIN_PROBABILITY = 0.60  # Минимальная вероятность успеха для входа (увеличено с 55% до 60%)
BAYESIAN_MIN_SAMPLES = 15  # Минимальное количество сигналов (увеличено с 10 до 15 для более надежной статистики)

# Z-Score Mean Reversion (для статистических моделей, если USE_STATISTICAL_MODELS = True)
ZSCORE_WINDOW = 50  # Окно для расчёта среднего
ZSCORE_BUY_THRESHOLD = -2.0  # Порог покупки (цена сильно ниже среднего)
ZSCORE_SELL_THRESHOLD = 2.0  # Порог продажи (цена сильно выше среднего)
# Для основной MR стратегии используются MR_ZSCORE_* параметры (строка 208+)

# Markov Regime Switching
MARKOV_WINDOW = 50  # Окно для анализа режима
MARKOV_VOL_HIGH = 0.03  # Порог высокой волатильности (3%)
MARKOV_VOL_LOW = 0.01  # Порог низкой волатильности (1%)
MARKOV_TREND_THRESHOLD = 0.02  # Порог тренда (2%)

# Ensemble Decision Maker (веса моделей)
ENSEMBLE_BAYESIAN_WEIGHT = 0.4  # Вес Bayesian модели (40%)
ENSEMBLE_ZSCORE_WEIGHT = 0.3  # Вес Z-score модели (30%)
ENSEMBLE_REGIME_WEIGHT = 0.3  # Вес Regime модели (30%)

# ====================================================================
# MEAN REVERSION STRATEGY
# ====================================================================

# Режим работы стратегии
STRATEGY_MODE = "HYBRID"  # "TREND_FOLLOWING", "MEAN_REVERSION", или "HYBRID"

# Параметры Mean Reversion v5.2 (ОПТИМИЗИРОВАНО: ужесточение фильтров для повышения качества)
MR_RSI_OVERSOLD = 32  # Порог перепроданности (ужесточено с 35 до 32 для лучшего качества сигналов)
MR_RSI_EXIT = 50  # Порог выхода (уменьшено с 52 для более раннего выхода)
MR_ZSCORE_BUY_THRESHOLD = -1.7  # Z-score порог покупки (ужесточено с -1.5 до -1.7 для лучшего качества)
MR_ZSCORE_SELL_THRESHOLD = 0.3  # Z-score порог выхода (уменьшено с 0.4 для более раннего выхода)
MR_ZSCORE_STRONG_BUY = -2.2  # Сильная перепроданность (ужесточено с -2.0 до -2.2 для более сильных сигналов)
MR_ADX_MAX = 28  # Максимальный ADX (ужесточено с 30 до 28 для более четкого флэта)
MR_EMA_DIVERGENCE_MAX = 0.018  # Максимальная дивергенция EMA (уменьшено с 2% до 1.8% для более четкого флэта)

# Размеры позиций для Mean Reversion v4 (ОПТИМИЗИРОВАНО: снижение риска)
MR_POSITION_SIZE_STRONG = 0.60  # 60% для сильной перепроданности (уменьшено с 70% для снижения риска)
MR_POSITION_SIZE_MEDIUM = 0.40  # 40% для умеренной перепроданности (уменьшено с 50% для снижения риска)
MR_POSITION_SIZE_WEAK = 0.25  # 25% для слабой перепроданности (уменьшено с 35% для снижения риска)

# TP/SL для Mean Reversion v5 (ОПТИМИЗИРОВАНО: улучшение R:R с учетом реальных данных)
MR_TAKE_PROFIT_PERCENT = 0.03  # 3% тейк-профит (уменьшено с 3.5% для более быстрого достижения)
MR_STOP_LOSS_PERCENT = 0.025  # 2.5% стоп-лосс (уменьшено с 2.8%, R:R = 1.2:1)
MR_MAX_HOLDING_HOURS = 18  # Максимум 18 часов удержания (уменьшено с 24h для более быстрого выхода)

# Z-score параметры для MR
MR_ZSCORE_WINDOW = 50  # Окно для расчёта среднего

# Фильтры "падающего ножа" v5.4 (ИСПРАВЛЕНО: отключен блокирующий EMA200 фильтр)
# ⚠️ РИСК: Отключение этих фильтров может привести к входу в "падающий нож"
# в сильном медвежьем тренде, что исторически приводит к крупным убыткам
NO_BUY_IF_PRICE_BELOW_N_DAY_LOW_PERCENT = 0.10  # Не входить если цена < min(24h) * 0.90
NO_BUY_IF_EMA200_SLOPE_NEG = False  # ИСПРАВЛЕНО: ОТКЛЮЧЕН (блокировал 100% сигналов!)
EMA200_NEG_SLOPE_THRESHOLD = -0.010  # -1.0% наклон EMA200 (не используется)
USE_RED_CANDLES_FILTER = True  # ВКЛЮЧЕН: блокировать при серии красных свечей

# Фильтр объёма v5.3 (смягчён)
USE_VOLUME_FILTER = True  # v5: Блокировать входы при всплесках объёма
VOLUME_SPIKE_THRESHOLD = 3.0  # v5.3: Не входить если volume > 3.0x средний за 24h (было 2.2, смягчили)

# Динамический SL на основе ATR v5 (ОПТИМИЗИРОВАНО: более тесный SL для лучшего R:R)
USE_DYNAMIC_SL_FOR_MR = True  # Использовать ATR-based SL вместо фиксированного
MR_ATR_SL_MULTIPLIER = 1.8  # Множитель ATR для SL (уменьшено с 2.0x для более тесного SL)
MR_ATR_SL_MIN = 0.018  # Минимальный SL 1.8% (уменьшено с 2%)
MR_ATR_SL_MAX = 0.035  # Максимальный SL 3.5% (уменьшено с 4%)

# Адаптивный SL v5 (ОТКЛЮЧЕН - не работал в v4)
ADAPTIVE_SL_ON_RISK = False  # v5: ОТКЛЮЧЕН (не эффективен, лучше блокировать вход)
ADAPTIVE_SL_MULTIPLIER = 1.5  # Увеличить SL на 50% при риске (не используется)

# Динамический TP v5 (ОПТИМИЗИРОВАНО: более быстрый выход для улучшения R:R)
USE_DYNAMIC_TP_FOR_MR = True  # Использовать динамический TP на основе ATR
MR_ATR_TP_MULTIPLIER = 2.5  # 2.5x ATR для TP (уменьшено с 2.8x для более быстрого достижения)
MR_ATR_TP_MIN = 0.022  # Минимум 2.2% (уменьшено с 2.5%)
MR_ATR_TP_MAX = 0.04  # Максимум 4% (уменьшено с 4.5%)

# Минимальный R:R контроль (ОПТИМИЗИРОВАНО: повышение минимального R:R)
MIN_RR_RATIO = 1.4  # Минимальный Risk:Reward ratio (увеличено с 1.25 до 1.4 для лучшей прибыльности)
ENFORCE_MIN_RR = True  # Принудительно обеспечивать минимальный R:R

# Трейлинг стоп для MR v5 (ОПТИМИЗИРОВАНО: более агрессивная защита прибыли)
USE_TRAILING_STOP_MR = True  # Включить трейлинг стоп после прибыли
MR_TRAILING_ACTIVATION = 0.012  # Активация после +1.2% (уменьшено с 1.5% для более ранней защиты)
MR_TRAILING_DISTANCE = 0.008  # 0.8% от максимума (уменьшено с 1.0% для более тесного трейлинга)

# Агрессивный трейлинг v5 (ОПТИМИЗИРОВАНО: более ранняя активация)
MR_TRAILING_AGGRESSIVE_ACTIVATION = 0.025  # После +2.5% прибыли (уменьшено с 3% для более ранней защиты)
MR_TRAILING_AGGRESSIVE_DISTANCE = 0.006  # 0.6% от максимума (уменьшено с 0.8% для более тесного трейлинга)

# ====================================================================
# ГИБРИДНАЯ СТРАТЕГИЯ (MR + TF с переключением по ADX)
# ====================================================================

STRATEGY_HYBRID_MODE = "AUTO"  # "AUTO" (переключение по ADX), "MR_ONLY", "TF_ONLY"

# Пороги ADX для переключения режимов (ИСПРАВЛЕНО: расширенные пороги для стабильности)
HYBRID_ADX_MR_THRESHOLD = 15  # ADX < 15 → Mean Reversion (боковик) - более четкий боковик
HYBRID_ADX_MR_EXIT = 22  # ADX > 22 → Выход из MR в TF (гистерезис)
HYBRID_ADX_TF_THRESHOLD = 30  # ADX > 30 → Trend Following (тренд) - более четкий тренд
HYBRID_ADX_TF_EXIT = 18  # ADX < 18 → Выход из TF в MR (гистерезис)
# 15 <= ADX <= 30 → переходная зона 15 пунктов (стабильная зона)

HYBRID_TRANSITION_MODE = "HOLD"  # КРИТИЧЕСКИ: только HOLD (запрет входов в переходной зоне)

# Минимальное время в режиме (защита от частого переключения)
HYBRID_MIN_TIME_IN_MODE = 2.0  # v5.7: 2 часа минимум (стабильное переключение)

# Кулдаун между сделками для одного символа (защита от частых сделок)
TRADE_COOLDOWN_MINUTES = 30  # Минимум 30 минут между сделками по одному символу
ENABLE_TRADE_COOLDOWN = True  # Включить кулдаун между сделками

# ====================================================================
# MULTI-TIMEFRAME ANALYSIS
# ====================================================================

# Использовать multi-timeframe анализ (1h, 4h, 1d) - оптимизировано для 1h
USE_MULTI_TIMEFRAME = True

# Таймфреймы для анализа (от меньшего к большему) - v5
MTF_TIMEFRAMES = ['1h', '4h', '1d']

# Веса для weighted voting (сумма должна быть 1.0) - v5
MTF_WEIGHTS = {
	'1h': 0.50,   # Основной таймфрейм (главный сигнал)
	'4h': 0.35,   # Среднесрочный тренд (подтверждение)
	'1d': 0.15    # Долгосрочный фильтр (защита от противотренда)
}

# Минимальное количество согласованных таймфреймов для входа - v5.1
MTF_MIN_AGREEMENT = 1  # Минимум 1 из 3 TF (используем weighted voting)

# Бонус за полное согласие всех таймфреймов
MTF_FULL_ALIGNMENT_BONUS = 1.5  # Увеличить силу сигнала на 50% если все 3 TF согласны

# ====================================================================
# API
# ====================================================================

# Таймаут для API запросов
API_TIMEOUT = 30  # секунд


# ====================================================================
# РЕЖИМЫ СТРАТЕГИЙ (константы для избежания хардкода)
# ====================================================================
MODE_MEAN_REVERSION = "MEAN_REVERSION"
MODE_TREND_FOLLOWING = "TREND_FOLLOWING"
MODE_TRANSITION = "TRANSITION"

# Константы типов стратегий для time exit
STRATEGY_TYPE_MR = "MR"
STRATEGY_TYPE_TF = "TF"
STRATEGY_TYPE_HYBRID = "HYBRID"

# Основной таймфрейм для MTF анализа (используется как fallback)
MTF_PRIMARY_TIMEFRAME = "1h"

# ====================================================================
# REAL TRADING CONFIGURATION
# ====================================================================

# Trading Mode Flags
ENABLE_PAPER_TRADING = True   # Включить paper trading
ENABLE_REAL_TRADING = True   # Включить реальную торговлю

# Bybit API (загружаются из .env)
BYBIT_API_KEY = os.getenv("BYBIT_API_KEY")
BYBIT_API_SECRET = os.getenv("BYBIT_API_SECRET")
BYBIT_TESTNET = os.getenv("BYBIT_TESTNET", "false").lower() == "true"  # True для testnet

# Отладочная информация для API ключей
import logging
logger = logging.getLogger(__name__)
logger.info(f"Config: BYBIT_API_KEY loaded = {BYBIT_API_KEY is not None}")
logger.info(f"Config: BYBIT_API_SECRET loaded = {BYBIT_API_SECRET is not None}")

# Real Trading Safety Limits
REAL_MAX_DAILY_LOSS = 50.0  # Макс убыток в день (USD)
REAL_MAX_POSITION_SIZE = 100.0  # Макс размер позиции (USD)
REAL_MIN_ORDER_VALUE = 5.0  # Минимальная сумма ордера (USD) для spot торговли (fallback, реальные лимиты получаются динамически)
REAL_ORDER_TYPE = "MARKET"  # "MARKET" или "LIMIT"
REAL_LIMIT_ORDER_OFFSET_PERCENT = 0.001  # 0.1% оффсет для лимитных ордеров

# ====================================================================
# МАЛЫЕ БАЛАНСЫ - АДАПТИВНЫЙ РАСЧЕТ РАЗМЕРА ПОЗИЦИЙ
# ====================================================================

# Пороги для малых балансов
SMALL_BALANCE_THRESHOLD = 50.0  # Порог малого баланса (USD)
SMALL_BALANCE_MIN_ORDER = 5.0  # Минимум для малых балансов (USD) - соответствует Bybit лимиту
SMALL_BALANCE_POSITION_MULTIPLIER = 1.2  # Увеличенный процент для малых балансов

# Динамические минимумы для торговых пар
USE_DYNAMIC_MIN_ORDER = True  # Использовать минимумы из БД для каждой пары
SYMBOL_INFO_UPDATE_HOURS = 24  # Обновлять информацию о парах раз в сутки

# ====================================================================
# ДИНАМИЧЕСКИЙ РАСЧЕТ MAX_POSITIONS
# ====================================================================

def get_dynamic_max_positions(total_balance: float) -> int:
	"""
	Рассчитывает максимальное количество одновременных позиций на основе баланса.
	
	Args:
		total_balance: Общий баланс (свободный + в позициях)
	
	Returns:
		Максимальное количество позиций для данного баланса
	"""
	if not USE_DYNAMIC_MAX_POSITIONS:
		return MAX_POSITIONS
	
	# Сортируем пороги по возрастанию
	sorted_thresholds = sorted(DYNAMIC_POSITIONS_THRESHOLDS.items())
	
	# Находим подходящий порог
	max_positions = sorted_thresholds[0][1]  # По умолчанию самый низкий уровень
	
	for threshold, positions in sorted_thresholds:
		if total_balance >= threshold:
			max_positions = positions
		else:
			break
	
	# Ограничиваем абсолютным максимумом
	return min(max_positions, MAX_DYNAMIC_POSITIONS_LIMIT)

